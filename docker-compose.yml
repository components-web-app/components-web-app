## This has been modified from the API Platform template implementation
## More specifically from https://github.com/dunglas/demo-vulcain-api-platform
version: '3.4'

x-cache-from:
    - &api-cache-from
        cache_from:
            - ${NGINX_IMAGE:-registry.gitlab.com/components-web-app/nginx}
            - ${PHP_IMAGE:-registry.gitlab.com/components-web-app/php}

services:
    php:
        build:
            context: ./api
            target: cwa_php
            <<: *api-cache-from
        image: ${PHP_IMAGE:-registry.gitlab.com/components-web-app/php}
        healthcheck:
            interval: 10s
            timeout: 3s
            retries: 3
            start_period: 30s
        depends_on:
            - db
            - dev-tls
        volumes:
            - ./api:/srv/api:rw,cached
            - ./api/docker/php/conf.d/cwa.dev.ini:/usr/local/etc/php/conf.d/cwa.ini
            # if you develop on Linux, you may use a bind-mounted host directory instead
            # - ./api/var:/srv/api/var:rw
            - dev-certs:/certs:ro,nocopy

    api:
        build:
            context: ./api
            target: cwa_nginx
            <<: *api-cache-from
        image: ${NGINX_IMAGE:-registry.gitlab.com/components-web-app/nginx}
        depends_on:
            - php
        volumes:
            - ./api/public:/srv/api/public:ro

    cache-proxy:
        build:
            context: ./api
            target: cwa_varnish
        restart: always
        depends_on:
            - api
        tmpfs:
            - /usr/local/var/varnish:exec

    vulcain:
        image: dunglas/vulcain
        environment:
            - CERT_FILE=/certs/localhost.crt
            - KEY_FILE=/certs/localhost.key
            - UPSTREAM=http://cache-proxy
        depends_on:
            - cache-proxy
            - dev-tls
        volumes:
            - dev-certs:/certs:ro
        ports:
            -   target: 443
                published: 8443
                protocol: tcp

    db:
        image: postgres:12-alpine
        environment:
            - POSTGRES_DB=api
            - POSTGRES_PASSWORD=!ChangeMe!
            - POSTGRES_USER=api-platform
        volumes:
            - db-data:/var/lib/postgresql/data:rw
            # you may use a bind-mounted host directory instead, so that it is harder to accidentally remove the volume and lose all your data!
            # - ./api/docker/db/data:/var/lib/postgresql/data:rw
        ports:
            -   target: 5432
                published: 5432
                protocol: tcp

    mercure:
        image: dunglas/mercure
        environment:
            - ALLOW_ANONYMOUS=1
            - CERT_FILE=/certs/localhost.crt
            - CORS_ALLOWED_ORIGINS=*
            - DEMO=1
            - JWT_KEY=!ChangeMe!
            - KEY_FILE=/certs/localhost.key
            - PUBLISH_ALLOWED_ORIGINS=https://localhost:1337 # required for publishing from the demo page
        depends_on:
            - dev-tls
        volumes:
            - dev-certs:/certs:ro
        ports:
            -   target: 443
                published: 1337
                protocol: tcp

    dev-tls:
        build:
            context: ./docker/dev-tls
        volumes:
            - dev-certs:/certs:rw
        ports:
            -   target: 80
                published: 80
                protocol: tcp

volumes:
    db-data: {}
    dev-certs: {}
